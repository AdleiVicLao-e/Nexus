<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Scanner with AR</title>
    <script src="res/js/client/jsQR.js"></script>
    <style>
      #video {
        width: 100%;
        max-width: 400px;
        display: block;
      }

      #canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      #result {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        font-size: 15px;
        font-weight: bold;
        background-color: #fac301;
        font-family: Arial, sans-serif;
        padding: 10px;
        border-radius: 5px;
      }

      #imgCatalogue {
        max-width: 30%;
        height: 50px;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background-color: #fac301;
        padding: 10px;
        border-radius: 5px;
      }

      .floating-button {
        position: absolute;
        bottom: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #0e1644;
        color: white;
        font-size: 24px;
        border: none;
        cursor: pointer;
        z-index: 1002;
      }

      .floating-button.left {
        display: block;
        border: 3px solid #fac301;
        left: 20px;
      }

      #watchVideosButton {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        padding: 0;
        border-radius: 50%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        background-image: url("/assets/img/button_background.png");
        background-size: cover;
        background-position: center;
        border: none;
        cursor: pointer;
        z-index: 1003;
        display: flex;
        justify-content: center;
        align-items: center;
        animation: zoomIn 3s;
        border: 3px solid white;
      }

      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .info-box {
        background-color: #fff;
        font-family: "Inter", sans-serif;
        background-image: url("/assets/img/info_box.png");
        background-size: cover;
        background-position: center;
        width: 0%;
        max-width: 500px;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        border: 3px solid #363636;
      }

      /* Timer styling */
      .timer {
        margin-top: 10px;
        font-size: 0.7em;
        color: #8a8989;
        font-family: "Inter", sans-serif;
      }

      .info-box-text {
        font-family: "Inter", sans-serif;
        font-size: 0.9em;
      }

      #watchVideosButton::before {
        content: "\25B6";
        color: white;
        font-size: 30px;
        display: block;
      }

      @keyframes zoomIn {
        0% {
          transform: scale(0.8);
        }

        100% {
          transform: scale(1);
        }
      }

      #watchVideosButton:hover {
        background-color: #fac301;
      }

      @keyframes shake {
        0% {
          transform: translate(-50%, -50%) translateX(-10px);
        }
        25% {
          transform: translate(-50%, -50%) translateX(10px);
        }
        50% {
          transform: translate(-50%, -50%) translateX(-10px);
        }
        75% {
          transform: translate(-50%, -50%) translateX(10px);
        }
        100% {
          transform: translate(-50%, -50%) translateX(0);
        }
      }

      @keyframes fadeOut {
        0% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      #noArtifactImage {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        height: auto;
        z-index: 10;
        animation: shake 1s ease-in-out infinite;
      }
    </style>
  </head>
  <body>
    <!-- AR Elements -->
    <video id="video" autoplay></video>
    <canvas id="canvas"></canvas>
    <div id="result">Scan a QR code</div>
    <img
      id="noArtifactImage"
      src="assets/img/Error.png"
      alt="No Artifact Found"
    />

    <img
      id="imgCatalogue"
      src="assets/catalogue/default.png"
      alt="Placeholder Image"
    />

    <!-- Floating Buttons -->
    <button class="floating-button left" onclick="viewDetails()">i</button>
    <button
      id="watchVideosButton"
      onclick="window.location.href='igorot-dances.html';"
    ></button>

    <!-- Overlay with the info box -->
    <div class="overlay" id="infoOverlay">
      <div class="info-box">
        <p class="welcome-2">WELCOME!</p>
        <p class="info-box-text">
          This is application will provide you with more information about the
          museum artifacts.
        </p>
        <p class="info-box-text">
          To use it, simply position your phone's camera in front of the QR
          codes located near the artifacts.
        </p>
        <p class="info-box-text">
          It will automatically detect the codes and display detailed
          information about each artifact.
        </p>

        <!-- Timer -->
        <p class="timer">
          This message will disappear in <span id="countdown">8</span> seconds.
        </p>
      </div>
    </div>

    <script>
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const canvasContext = canvas.getContext("2d");
      const resultDiv = document.getElementById("result");
      const noArtifactImage = document.getElementById("noArtifactImage");
      const imgElement = document.getElementById("imgCatalogue");

      let artifactInfo = "";
      let displayBox = true;
      let imageValue = "default";

      // Function to start video stream
      async function startVideo() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });
          video.srcObject = stream;
          video.setAttribute("playsinline", true); // required to play video inline on iOS
          video.play();
          requestAnimationFrame(scanQRCode);
        } catch (error) {
          console.error("Error accessing webcam:", error);
        }
      }

      // Function to scan QR code
      function scanQRCode() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = canvasContext.getImageData(
            0,
            0,
            canvas.width,
            canvas.height
          );
          const code = jsQR(imageData.data, canvas.width, canvas.height, {
            inversionAttempts: "dontInvert",
          });

          canvasContext.clearRect(0, 0, canvas.width, canvas.height);
          canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);

          if (code) {
            const artifactId = code.data;
            resultDiv.textContent = `QR Code Detected`;
            fetchArtifactInfo(artifactId);

            if (displayBox) {
              // Check if the box should be displayed
              console.log("Drawing box..."); // Debugging log

              const centerX =
                (code.location.topLeftCorner.x +
                  code.location.topRightCorner.x) /
                2;
              const centerY =
                (code.location.topLeftCorner.y +
                  code.location.bottomLeftCorner.y) /
                2;

              const boxWidth = 350;
              const boxHeight = 200;
              const depth = 20;
              const padding = 20;

              // Front face of the rectangle (Book cover)
              canvasContext.fillStyle = "rgba(14, 22, 68, 0.95)";
              canvasContext.fillRect(
                centerX - boxWidth / 2,
                centerY - boxHeight / 2,
                boxWidth,
                boxHeight
              );

              // Right side of the cube (Spine of the book)
              canvasContext.beginPath();
              canvasContext.moveTo(
                centerX + boxWidth / 2,
                centerY - boxHeight / 2
              );
              canvasContext.lineTo(
                centerX + boxWidth / 2 + depth,
                centerY - boxHeight / 2 - depth
              );
              canvasContext.lineTo(
                centerX + boxWidth / 2 + depth,
                centerY + boxHeight / 2 - depth
              );
              canvasContext.lineTo(
                centerX + boxWidth / 2,
                centerY + boxHeight / 2
              );
              canvasContext.closePath();
              canvasContext.fillStyle = "rgba(14, 22, 68, 0.95)";
              canvasContext.fill();

              // Top side of the cube (Pages of the book)
              canvasContext.beginPath();
              canvasContext.moveTo(
                centerX - boxWidth / 2,
                centerY - boxHeight / 2
              );
              canvasContext.lineTo(
                centerX - boxWidth / 2 + depth,
                centerY - boxHeight / 2 - depth
              );
              canvasContext.lineTo(
                centerX + boxWidth / 2 + depth,
                centerY - boxHeight / 2 - depth
              );
              canvasContext.lineTo(
                centerX + boxWidth / 2,
                centerY - boxHeight / 2
              );
              canvasContext.closePath();
              canvasContext.fillStyle = "rgba(14, 22, 68, 0.8)";
              canvasContext.fill();

              // Left side of the cube (Back cover of the book or edge)
              canvasContext.beginPath();
              canvasContext.moveTo(
                centerX - boxWidth / 2,
                centerY - boxHeight / 2
              );
              canvasContext.lineTo(
                centerX - boxWidth / 2 + depth,
                centerY - boxHeight / 2 - depth
              );
              canvasContext.lineTo(
                centerX - boxWidth / 2 + depth,
                centerY + boxHeight / 2 - depth
              );
              canvasContext.lineTo(
                centerX - boxWidth / 2,
                centerY + boxHeight / 2
              );
              canvasContext.closePath();
              canvasContext.fillStyle = "rgba(14, 22, 68, 0.8)";
              canvasContext.fill();

              // Add the text inside the front face of the rectangle (Book title or information)
              canvasContext.font = "15px Arial";
              canvasContext.fillStyle = "white";
              canvasContext.textAlign = "center";
              canvasContext.textBaseline = "middle";

              if (artifactInfo) {
                const lines = artifactInfo.split("\n");
                lines.forEach((line, index) => {
                  canvasContext.fillText(
                    line,
                    centerX,
                    centerY - boxHeight / 2 + padding + (index + 1) * 15
                  );
                });
              }
            }
          } else {
            resultDiv.textContent = "No QR Code Detected";
            document.getElementById("watchVideosButton").style.display = "none";
            artifactInfo = "";
          }
        }
        requestAnimationFrame(scanQRCode);
      }

      function fetchArtifactInfo(artifactId) {
        fetch(`include/getArtifact.php?artifact_id=${artifactId}`)
          .then((response) => response.json())
          .then((data) => {
            console.log("Data:", data);

            if (data && Object.keys(data).length > 0) {
              // If artifact is found
              artifactInfo = `
                    \nArtifact Name: ${data["Name"] || "N/A"}
                    \n \nCatalogue Name: ${data["Catalogue Name"] || "N/A"}
                    \nSubcatalogue Name: ${data["Subcatalogue Name"] || "N/A"}
                    \nDescription: ${data["Description"] || "N/A"}
                `.trim();
              noArtifactImage.style.display = "none";
              displayBox = true;
              document.getElementById("result").style.display = "block";
              document.getElementById("watchVideosButton").style.display =
                "block";
              let imageValue = data["Catalogue Name"] || "default";
              changeImage(imageValue);
            } else {
              // If artifact is not found
              artifactInfo = "";
              noArtifactImage.style.display = "block";
              resultDiv.textContent = `No artifact found`;
              displayBox = false;
              let imageValue = data["Catalogue Name"] || "default";
              document.getElementById("result").style.display = "none";
              document.getElementById("watchVideosButton").style.display =
                "none";

              setTimeout(() => {
                noArtifactImage.style.animation = "none";
                noArtifactImage.style.opacity = 0;
                setTimeout(() => {
                  noArtifactImage.style.display = "none";
                  noArtifactImage.style.opacity = 1;
                }, 1000);
              }, 2000);
            }
          })
          .catch((error) => {
            let imageValue = data["Catalogue Name"] || "default";
            document.getElementById("watchVideosButton").style.display = "none";
            console.error("Error fetching artifact info:", error);
            artifactInfo = "Error fetching artifact info";
            noArtifactImage.style.display = "block";
          });
      }

      // Function to show the overlay
      function viewDetails() {
        const overlay = document.getElementById("infoOverlay");
        overlay.style.display = "flex";

        let countdownTime = 6;
        const countdownElement = document.getElementById("countdown");

        // Update the countdown every second
        const countdownInterval = setInterval(() => {
          countdownTime--;
          countdownElement.textContent = countdownTime;

          // When countdown reaches 0, hide the overlay
          if (countdownTime <= 0) {
            clearInterval(countdownInterval);
            overlay.style.display = "none";
          }
        }, 1000);
      }

      function changeImage(value) {
        if (value === "Traditional wood arts") {
          imgElement.src = "assets/catalogue/1.png";
        } else if (value === "Contemporary wood arts") {
          imgElement.src = "assets/catalogue/2.png";
        } else if (value === "Gongs and drums") {
          imgElement.src = "assets/catalogue/3.png";
        } else if (value === "Flute (nose and mouth)") {
          imgElement.src = "assets/catalogue/4.png";
        } else if (value === "Tambi (bamboo stringed percussion)") {
          imgElement.src = "assets/catalogue/5.png";
        } else if (value === "Food containers and storage bins") {
          imgElement.src = "assets/catalogue/6.png";
        } else {
          imgElement.src = "assets/catalogue/default.png"; // Default image
        }
      }

      window.addEventListener("pageshow", (event) => {
        if (event.persisted) {
          // The page was loaded from the bfcache (back-forward cache)
          window.location.reload();
        }
      });

      // Start the video stream when the page loads
      startVideo();
    </script>
  </body>
</html>
