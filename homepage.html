<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Homepage</title>
    <link rel="stylesheet" href="./res/css/styles.css">
    <link rel="icon" href="./assets/img/favicon.png" type="image/x-icon">
    <link href="./assets/img/favicon.png" rel="icon">
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    >
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    >
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"
      integrity="sha512-k/KAe4Yff9EUdYI5/IAHlwUswqeipP+Cp5qnrsUjTPCgl51La2/JhyyjNciztD7mWNKLSXci48m7cctATKfLlQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="./res/js/jsQR.js"></script>
    <script src="./res/js/aframe.min.js"></script>
    <script src="./res/js/aframe-ar.js"></script>
    <script src="./res/js/aframe-text-geometry-component.min.js"></script>
    <link
      href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css"
      rel="stylesheet"
    >
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body data-rsssl="1">
    <nav></nav>

    <main>
      <video id="video" autoplay style="visibility: hidden"></video>
      <canvas id="canvas" style="visibility: hidden"></canvas>

      <a-scene vr-mode-ui="enabled: false" arjs="debugUIEnabled: false;" device-orientation-permission-ui="enabled: false">
        <a-assets>
          <a-asset-item id="exoFont" src="./assets/fonts/exoBlack.typeface.json"></a-asset-item>
          <img id="pixels" src="./assets/img/pixels.png" alt="pixels">
        </a-assets>

        <!-- Text Box Background -->
        <a-plane id="textBox"></a-plane>
        <!-- Main Text -->
        <a-text id="text"></a-text>
        <a-box id="cube"></a-box>

      </a-scene>
    </main>
    <div id="va-container">
      <canvas id="va-canvas"></canvas>
    </div>

    <!-- Floating Buttons -->
    <button class="floating-button left" onclick="viewDetails()">i</button>
    <button
      id="watchVideosButton"
      class="floating-button"
      onclick="watchVideos()"
    >
    </button>

    <script>
      // Initialize video and canvas elements
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const canvasContext = canvas.getContext("2d");
      const text = document.getElementById("text");
      // const textBox = document.getElementById("textBox");
      const box = document.getElementById("cube");
      let currentCodeData = null;
      let artifactInfo = "";

      // Start scanning when the page loads
      startScanning();

      // Function to start the camera and scan QR codes
      function startScanning() {
        navigator.mediaDevices
          .getUserMedia({
            video: {
              facingMode: "environment",
            },
          })
          .then((stream) => {
            video.srcObject = stream;
            video.setAttribute("playsinline", true); // For iOS compatibility
            video.play();
            requestAnimationFrame(scanQRCode);
          })
          .catch((err) => console.error("Camera access error:", err));
      }

      // Function to scan QR codes
      function scanQRCode() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);

          onQRCodeDetected(code);
        }
        // Continue scanning
        requestAnimationFrame(scanQRCode);
      }

      // When QR code is detected
      function onQRCodeDetected(code) {
        if (code) {
          const artifactId = code.data;

          if (artifactId !== currentCodeData) {
            currentCodeData = artifactId;

            // Set the text properties
            text.setAttribute("font", "./assets/fonts/Exo2Bold.fnt");
            text.setAttribute("color", "white");
            text.setAttribute("rotation", "-5 20 0");
            text.setAttribute("position", "0 1.6 -10");
            text.setAttribute("align", "center");
            text.setAttribute("width", "5");
            text.setAttribute("wrap-count", "30");

            box.setAttribute("position", { x: 0.2, y: 1.2, z: -12 });
            box.setAttribute("rotation", { x: -5, y: 20, z: 0 });
            box.setAttribute("scale", { x: 6, y: 5, z: 3 });
            box.setAttribute("color", "#073066");
            box.setAttribute("material", "opacity", 0.8);

            // Set the text value
            // switch (artifactId) {
            //   case "1":
            //     text.setAttribute(
            //       "value",
            //       `Artifact Id: 1\nSection Name: Wood arts\nCatalogue Name: Traditional wood arts\nName: House door\nDescription: With surface carvings of animals and other designs\nCondition: With cracks\n`
            //     );
            //     break;
            //   case "2":
            //     text.setAttribute(
            //       "value",
            //       `Artifact Id: 2\nSection Name: Wood arts\nCatalogue Name: Contemporary wood arts\nName: Panel wall\nDescription: With surface carvings of animals and other designs\nCondition: With cracks\n`
            //     );
            //     break;
            //   case "3":
            //     text.setAttribute(
            //       "value",
            //       `Artifact Id: THREE\nSection Name: Musical instruments\nCatalogue Name: Gongs and drums\nName: Gong handle 1\nDescription: With back-to-back anthropomorphic motif\nCondition: No problem.\n`
            //     );
            //     break;
            //   default:
            //     text.setAttribute(
            //       "value",
            //       "Whoops! We couldn't fetch the artifact details. Please try again!"
            //     );
            //     text.setAttribute("color", "red");
            //     break;
            // }

            // Show the view details button
            document.getElementById("watchVideosButton").style.display =
              "block";

            fetchArtifactInfo(artifactId);
          }
        } else {
          // QR code not detected, reset or clear the display
          currentCodeData = null;
          box.setAttribute("visible", "false");
          text.setAttribute("value", ""); // Clear text

          // Hide the view details button
          document.getElementById("watchVideosButton").style.display = "none";
        }
      }

      function viewDetails() {
        alert(
          "Welcome! \nThis is a QR code scanning application designed to provide you with more information about the museum artifacts. \nTo use it, simply position your phone's camera in front of the QR codes located near the artifacts. \nThe app will automatically detect the codes and display detailed information about each artifact."
        );
      }

      function watchVideos() {
        window.location.href = "igorot-dances.html";
      }

      function reloadPage() {
        location.reload();
      }

      function fetchArtifactInfo(artifactId) {
        fetch(`getArtifact.php?artifact_id=${artifactId}`)
                .then((response) => response.json())
                .then((data) => {
                  if (data) {
                    console.log("Data:", data);
                    const artifactInfo = `
                    Artifact Id: ${data['Artifact Id']}
                    Section Name: ${data['Section Name']}
                    Catalogue Name: ${data['Catalogue Name']}
                    Subcatalogue Name: ${data['Subcatalogue Name']}
                    Name: ${data['Name']}
                    Description: ${data['Description']}
                    Condition: ${data['Condition']}
                `.trim();
                    text.setAttribute("value", artifactInfo);
                  } else {
                    text.setAttribute("value", "Artifact not found");
                  }
                })
                .catch((error) => {
                  console.error("Error fetching artifact info:", error);
                  text.setAttribute("value", "ERROR: \nUnable to fetch artifact information.");
                  text.setAttribute("font", "./assets/fonts/Exo2Bold.fnt");
                  text.setAttribute("color", "red");
                  text.setAttribute("rotation", "0 0 0");
                  text.setAttribute("position", "0 1.6 -10");
                  text.setAttribute("align", "center");
                  text.setAttribute("width", "5");
                  text.setAttribute("wrap-count", "30");

                  box.setAttribute("visible", "false"); 
                  });
      }
    </script>

     <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js"></script>
    <script src="./res/js/VA.js"></script>
    <script src="./res/js/speakClient.js"></script>
    <script src="./res/js/scripts.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
  </body>
</html>
