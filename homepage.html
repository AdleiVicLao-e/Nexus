<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Homepage</title>
  <link rel="stylesheet" href="res/css/styles.css">
  <link rel="icon" href="assets/img/favicon.png" type="image/x-icon">
  <link href="assets/img/favicon.png" rel="icon">
  <link
          rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
  >
  <link
          rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  >
  <script
          src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"
          integrity="sha512-k/KAe4Yff9EUdYI5/IAHlwUswqeipP+Cp5qnrsUjTPCgl51La2/JhyyjNciztD7mWNKLSXci48m7cctATKfLlQ=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer"
  ></script>
  <script src="res/js/jsQR.js"></script>
  <script src="res/js/aframe.min.js"></script>
  <script src="res/js/aframe-ar.js"></script>
  <script src="res/js/aframe-text-geometry-component.min.js"></script>
  <link
          href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css"
          rel="stylesheet"
  >
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body data-rsssl="1">
<nav></nav>

<main>
  <video id="video" autoplay style="visibility: hidden"></video>
  <canvas id="canvas" style="visibility: hidden"></canvas>

  <a-scene vr-mode-ui="enabled: false" arjs="debugUIEnabled: false;" device-orientation-permission-ui="enabled: false">
    <a-assets>
      <a-asset-item id="exoFont" src="./assets/fonts/exoBlack.typeface.json"></a-asset-item>
      <img id="pixels" src="assets/img/pixels.png" alt="pixels">
      <img id="errorImage" src="assets/img/Error.png" alt="error message">
      <img id="artifactBackground" src="assets/img/artifact_background.png" alt="artifact background">
    </a-assets>

    <!-- Add AR components here -->
    <a-image
            id="artifact-background"
            src="./assets/img/artifact_background.png"
            position="0 1.65 -3"
            width="2.2"
            height="2"
            visible="false"
            material="opacity: 0.9; transparent: true;">
    </a-image>

    <a-image
            id="error-image"
            src="./assets/img/Error.png"
            position="0 1.6 -2.5"
            width="2"
            height="1"
            visible="false"
            material="opacity: 0.9; transparent: true;"
            animation__shake="
            property: position;
            dir: alternate;
            dur: 100;
            easing: easeInOutQuad;
            loop: true;
            to: 0.1 1.6 -2.5;">
    </a-image>

    <a-text
            id="artifact-title"
            font="./assets/fonts/Exo2Bold.fnt"
            position="-0.5 2 -2.5"
            width="1.25"
            rotation="0 0 0"
            wrap-count="25"
            color="black">
    </a-text>

    <a-text
            id="text"
            font="./assets/fonts/Exo2Bold.fnt"
            position="-0.5 1.65 -2.5"
            width="1"
            rotation="0 0 0"
            wrap-count="25"
            color="black">
    </a-text>
    
  </a-scene>
</main>

<div id="va-container">
  <canvas id="va-canvas"></canvas>
</div>

<!-- Floating Buttons -->
<button class="floating-button left" onclick="viewDetails()">i</button>
<button
    id="watchVideosButton"
    onclick="window.location.href='igorot-dances.html';"
>
</button>

<!-- Overlay with the info box -->
<div class="overlay" id="infoOverlay">
  <div class="info-box">
    <p class="welcome-2">WELCOME!</p>
    <p class="info-box-text">This is application will provide you with more information about the museum artifacts.</p>
    <p class="info-box-text">To use it, simply position your phone's camera in front of the QR codes located near the artifacts.</p>
    <p class="info-box-text">It will automatically detect the codes and display detailed information about each artifact.</p>

    <!-- Timer -->
    <p class="timer">This message will disappear in <span id="countdown">8</span> seconds.</p>
  </div>
</div>

<div id="desktop-warning">
  Mobile Only Site.
</div>

<script>
  // Run the function on load
  window.onload = checkDevice;
  
  // Initialize video and canvas elements
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const artifactBackground=document.getElementById("artifact-background");
  const canvasContext = canvas.getContext("2d");
  const text = document.getElementById("text");
  const artifactTitle = document.getElementById("artifact-title");
  let currentCodeData = null;
  const errorImage = document.getElementById("error-image");
  let artifactInfo = "";

  // Start scanning when the page loads
  startScanning();

  // Function to start the camera and scan QR codes
  function startScanning() {
    navigator.mediaDevices
            .getUserMedia({
              video: {
                facingMode: "environment",
              },
            })
            .then((stream) => {
              video.srcObject = stream;
              video.setAttribute("playsinline", true); // For iOS compatibility
              video.play();
              requestAnimationFrame(scanQRCode);
            })
            .catch((err) => console.error("Camera access error:", err));
  }

  // Function to scan QR codes
  function scanQRCode() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);

      onQRCodeDetected(code);
    }
    // Continue scanning
    requestAnimationFrame(scanQRCode);
  }

  // When QR code is detected
  function onQRCodeDetected(code) {
    if (code) {
      const artifactId = code.data;

      if (artifactId !== currentCodeData) {
        currentCodeData = artifactId;

        fetchArtifactInfo(artifactId);
      }
    } else {
      // QR code not detected, reset or clear the display
      currentCodeData = null;
      text.setAttribute("value", "");
      artifactTitle.setAttribute("value","");
      errorImage.setAttribute("visible", "false");
      artifactBackground.setAttribute("visible", "false");
      document.getElementById("watchVideosButton").style.display = "none";
    }
  }

  // Function to show the overlay
  function viewDetails() {
    const overlay = document.getElementById("infoOverlay");
    overlay.style.display = "flex";

    let countdownTime = 8;
    const countdownElement = document.getElementById("countdown");

    // Update the countdown every second
    const countdownInterval = setInterval(() => {
      countdownTime--;
      countdownElement.textContent = countdownTime;

      // When countdown reaches 0, hide the overlay
      if (countdownTime <= 0) {
        clearInterval(countdownInterval);
        overlay.style.display = "none";
      }
    }, 1000);
  }

  function fetchArtifactInfo(artifactId) {
      fetch(`include/getArtifact.php?artifact_id=${artifactId}`)
        .then(response => response.json())
        .then(data => {
          console.log("Data:", data); // Log the data to inspect

          if (data) {
            // Build artifactInfo dynamically

          let artifactInfo = '';
          // let title = '';

          // if (data['Name'] && data['Name'] !== 'N/A') {
          //   title = `${data['Name']}\n`;
          // }

          if (data['Name'] && data['Name'] !== 'N/A') {
            artifactInfo += `${data['Name']}\n`;
          }

          if (data['Section Name'] && data['Section Name'] !== 'N/A') {
            artifactInfo += `Section Name: ${data['Section Name']}\n`;
          }

          if (data['Catalogue Name'] && data['Catalogue Name'] !== 'N/A') {
            artifactInfo += `Catalogue Name: ${data['Catalogue Name']}\n`;
          }

          if (data['Subcatalogue Name'] && data['Subcatalogue Name'] !== 'N/A') {
            artifactInfo += `Subcatalogue Name: ${data['Subcatalogue Name']}\n`;
          }

          if (data['Description'] && data['Description'] !== 'No description available') {
            artifactInfo += `Description: ${data['Description']}`;
          }
            // artifactTitle.setAttribute("value", title);
            text.setAttribute("value", artifactInfo);
            artifactBackground.setAttribute("visible", "true");
            document.getElementById("watchVideosButton").style.display = "block";

            adjustTextAndBackground(); 
            updatePositions();
            
          } else {
            // Handle the case where data is missing or empty
            // artifactTitle.setAttribute("value", "");
            text.setAttribute("value", "");
            errorImage.setAttribute("visible", "true");
            artifactBackground.setAttribute("visible", "false");
            document.getElementById("watchVideosButton").style.display = "none";
          }
        })
        .catch(error => {
          // Handle the error scenario
          errorImage.setAttribute("visible", "true");
          text.setAttribute("value", "");
          // artifactTitle.setAttribute("value", "");
          artifactBackground.setAttribute("visible", "false");
          document.getElementById("watchVideosButton").style.display = "none";
        });
    }

   // Function to detect screen width
   function checkDevice() {
        // Define a breakpoint for mobile devices (e.g., 768px)
        if (window.innerWidth > 768) {
            // Show the overlay and alert the user
            document.getElementById('desktop-warning').style.display = 'flex';
            alert("Please use your mobile phone to access this site.");
        }
    }

    // Optionally, rerun when the window is resized
    window.onresize = checkDevice;

    function adjustTextAndBackground() {
    const textElement = document.getElementById("text"); // Changed to target the text element directly
    const artifactBackground = document.getElementById("artifact-background");

    // Get the text content
    const textContent = textElement.getAttribute("value");

    // Approximate text dimensions
    const averageCharWidth = 0.1; 
    const averageCharHeight = 0.3; 
    const padding = 0.5; 

    // Estimate text size
    const textWidth = textContent.length * averageCharWidth + padding * 2;
    const textHeight = averageCharHeight * 2 + padding; 

    // Set maximum width and height
    const maxWidth = 2;  
    const maxHeight = 6; 

    // Ensure width does not exceed maxWidth
    const adjustedWidth = Math.min(textWidth * 1.1, maxWidth); 
    const adjustedHeight = Math.min(textHeight * 1.4, maxHeight); 

    artifactBackground.setAttribute("width", adjustedWidth); 
    artifactBackground.setAttribute("height", adjustedHeight); 

    // Make the background visible
    artifactBackground.setAttribute("visible", "true");
}

function updatePositions() {
    const artifactBackground = document.getElementById("artifact-background");
    const textElement = document.getElementById("text");

    // Get the current time
    const time = Date.now() * 0.002; 

    // Calculate wave effect
    const waveHeight = 0.1; 
    const frequency = 1;

    // Calculate new positions
    const backgroundY = Math.sin(time * frequency) * waveHeight;
    const textY = Math.sin(time * frequency) * waveHeight;

    // Update positions of background and text
    artifactBackground.setAttribute("position", `0 ${1.65 + backgroundY} -3`);
    textElement.setAttribute("position", `-0.5 ${1.65 + textY} -2.5`);

    // Request the next frame
    requestAnimationFrame(updatePositions);
}
</script>

<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js"></script>
<script src="res/js/VA.js"></script>
<script src="res/js/speakClient.js"></script>
<script src="res/js/scripts.js"></script>
<script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
</body>
</html>