<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Museum Artifact AR Experience</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
      }
      .artifact-info {
        position: absolute;
        top: 10px;
        left: 10px;
        padding: 15px;
        border: 2px solid #fac301;
        background-color: rgba(14, 22, 68, 0.9);
        color: white;
        border-radius: 20px;
        font-family: Arial, sans-serif;
        z-index: 10;
      }
      .magnifying-glass {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100px;
        height: 100px;
        transform: translate(-50%, -50%);
        display: none;
        animation: wave 1s ease-out;
      }

      /* Keyframes for waving animation */
      @keyframes wave {
        0% {
          transform: translate(-50%, -50%) rotate(0deg);
        }
        50% {
          transform: translate(-50%, -50%) rotate(15deg);
        }
        100% {
          transform: translate(-50%, -50%) rotate(-15deg);
        }
      }
    </style>
  </head>
  <body>
    <!-- Placeholder for showing artifact info -->
    <div class="artifact-info" id="artifact-info">
      Scan the QR code to view artifact details.
    </div>

    <!-- Magnifying Glass -->
    <img
      src="/assets/img/magnifying_glass.png"
      class="magnifying-glass"
      id="magnifying-glass"
      alt="Magnifying Glass"
    />

    <!-- AR.js scene -->
    <a-scene
      vr-mode-ui="enabled: false"
      arjs="debugUIEnabled: false;"
      device-orientation-permission-ui="enabled: false"
    >
      <!-- Camera -->
      <a-marker id="artifact-marker" type="barcode" barcodeValue="null">
        <!-- AR Elements (initially invisible) -->
        <a-image
          id="artifact-image"
          src="assets/img/information.png"
          position="0 0 0"
          scale="4 6 4"
          rotation="0 0 0"
          visible="false"
        ></a-image>

        <a-text
          id="artifact-text"
          value="Loading..."
          position="0 0.5 0"
          scale="6 6 6"
          rotation="0 0 0"
          visible="false"
          backgroundColor="#000000"
          padding="10"
        ></a-text>
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>

    <!-- QR Code scanning setup -->
    <video id="video" style="display: none"></video>
    <canvas id="canvas" style="display: none"></canvas>

    <script>
      let currentCodeData = null;

      // Function to start the camera and scan QR codes
      function startScanning() {
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const canvasContext = canvas.getContext("2d");

        navigator.mediaDevices
          .getUserMedia({
            video: { facingMode: "environment" },
          })
          .then((stream) => {
            video.srcObject = stream;
            video.setAttribute("playsinline", true);
            video.play();
            requestAnimationFrame(scanQRCode);
          })
          .catch((err) => console.error("Camera access error:", err));

        // Function to scan QR codes
        function scanQRCode() {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = canvasContext.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );
            const code = jsQR(imageData.data, canvas.width, canvas.height);

            onQRCodeDetected(code);
          }
          // Continue scanning
          requestAnimationFrame(scanQRCode);
        }

        // When QR code is detected
        function onQRCodeDetected(code) {
          if (code && code.data) {
            const artifactId = code.data;

            if (artifactId !== currentCodeData) {
              currentCodeData = artifactId;
              fetchArtifactInfo(artifactId);

              // Show magnifying glass in the center of the screen for 3 seconds with animation
              const magnifyingGlass =
                document.getElementById("magnifying-glass");
              magnifyingGlass.style.display = "block";
              setTimeout(() => {
                magnifyingGlass.style.display = "none";
              }, 2000); // Duration of animation

              // Show AR elements only if QR code is detected
              document
                .getElementById("artifact-image")
                .setAttribute("visible", false);
              document
                .getElementById("artifact-text")
                .setAttribute("visible", false);
            }
          }
        }
      }

      // Function to fetch artifact information from the database
      function fetchArtifactInfo(artifactId) {
        fetch(`include/getArtifact.php?artifact_id=${artifactId}`)
          .then((response) => response.json())
          .then((data) => {
            console.log("Data:", data);

            if (data) {
              let artifactInfo = "";

              if (data["Name"] && data["Name"] !== "N/A") {
                artifactInfo += `${data["Name"]}\n`;
              }

              if (data["Section Name"] && data["Section Name"] !== "N/A") {
                artifactInfo += `Section Name: ${data["Section Name"]}\n`;
              }

              if (data["Catalogue Name"] && data["Catalogue Name"] !== "N/A") {
                artifactInfo += `Catalogue Name: ${data["Catalogue Name"]}\n`;
              }

              if (
                data["Subcatalogue Name"] &&
                data["Subcatalogue Name"] !== "N/A"
              ) {
                artifactInfo += `Subcatalogue Name: ${data["Subcatalogue Name"]}\n`;
              }

              if (
                data["Description"] &&
                data["Description"] !== "No description available"
              ) {
                artifactInfo += `Description: ${data["Description"]}`;
              }

              document.getElementById("artifact-info").innerText = artifactInfo;
              document
                .getElementById("artifact-text")
                .setAttribute("value", data["Name"] || "No Name Available");
            } else {
              document.getElementById("artifact-info").innerText =
                "No data available for this artifact.";
              document
                .getElementById("artifact-text")
                .setAttribute("value", "No data available");
              document
                .getElementById("artifact-image")
                .setAttribute("visible", false);
              document
                .getElementById("artifact-text")
                .setAttribute("visible", false);
            }
          })
          .catch((error) => {
            console.error("Error fetching artifact data:", error);
            document.getElementById("artifact-info").innerText =
              "Error fetching data.";
            document
              .getElementById("artifact-text")
              .setAttribute("value", "Error fetching data");
            document
              .getElementById("artifact-image")
              .setAttribute("visible", false);
            document
              .getElementById("artifact-text")
              .setAttribute("visible", false);
          });
      }

      // Start scanning on page load
      window.addEventListener("load", startScanning);
    </script>
  </body>
</html>
